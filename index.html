<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><title>Tower Building</title><link rel="icon" type="image/x-icon" href="./assets/favicon.png"><style>*{margin:0;padding:0}img{width:100%}html{background:#fff;height:100%}body{font-family:"Helvetica Neue",Arial,Helvetica,sans-serif;margin:0 auto;text-align:center;width:100%;height:100%;background:#f95240 url(assets/main-bg.png)}@media screen and (min-height:560px){html{font-size:100px}}@media screen and (min-height:640px){html{font-size:112.5px}}@media screen and (min-height:720px){html{font-size:125px}}@media screen and (min-height:800px){html{font-size:137.5px}}@media screen and (min-height:880px){html{font-size:150px}}@media screen and (min-height:960px){html{font-size:162.5px}}@media screen and (min-height:1040px){html{font-size:180px}}@media screen and (min-height:1200px){html{font-size:200px}}html{font-size:17.6vh}#canvas{position:fixed;left:0;top:0;right:0;bottom:0;margin:auto}a{text-decoration:none}li,ol,ul{list-style-type:none;padding:0;margin:0}.hide{display:none}.clear{clear:both}.loading{background-color:#f05a50;height:100%;width:100%}.loading .main{width:60%;margin:0 auto;color:#fff}.loading .main img{width:60%;margin:1rem auto 0}.loading .main .title{font-size:.3rem}.loading .main .text{font-size:.15rem}.loading .main .bar{height:.12rem;width:100%;border:3px solid #fff;border-radius:.6rem;margin:.1rem 0}.loading .main .bar .sub{height:.1rem;width:98%;margin:.008rem auto 0}.loading .main .bar .percent{height:100%;width:0;background-color:#fff;border-radius:.6rem}.loading .logo{position:absolute;bottom:.3rem;left:0;right:0}.loading .logo img{width:1rem}.content{height:100vh;margin:0 auto;position:relative}.landing .title{width:60%}.landing .logo{width:30%;position:absolute;right:.2rem;top:.2rem}.landing .action-2{position:absolute;bottom:.2rem;width:100%}.landing .start{width:65%}.slideTop{-webkit-animation:st 1s ease-in-out;animation:st 1s ease-in-out}@-webkit-keyframes st{0%{transform:translateZ(0)}100%{transform:translate3d(0,-100%,0)}}@keyframes st{0%{transform:translateZ(0)}100%{transform:translate3d(0,-100%,0)}}.slideBottom{-webkit-animation:sb 1s ease-in-out;animation:sb 1s ease-in-out}@-webkit-keyframes sb{0%{transform:translateZ(0)}100%{transform:translate3d(0,200%,0)}}@keyframes sb{0%{transform:translateZ(0)}100%{transform:translate3d(0,200%,0)}}.swing{-webkit-animation:sw 2s ease-in-out alternate infinite;animation:sw 2s ease-in-out alternate infinite}@-webkit-keyframes sw{0%{transform:rotate(5deg);transform-origin:top center}100%{transform:rotate(-5deg);transform-origin:top center}}@keyframes sw{0%{transform:rotate(5deg);transform-origin:top center}100%{transform:rotate(-5deg);transform-origin:top center}}.modal .mask{background-color:#000;opacity:.6;position:fixed;height:100%;width:100%;top:0;left:0}.modal .modal-content{position:fixed;height:100%;width:90%;margin-top:.3rem;top:0}.modal .main{width:85%;margin:0 auto}.modal .container{position:relative}.modal .bg{width:100%;position:absolute;top:0;left:0}.modal .modal-main{width:100%;position:absolute;top:0;left:0;margin-top:-.4rem}.modal .over-img{width:80%;margin:.8rem auto 0}.modal .over-score{margin-top:-.2rem;font-size:.5rem;color:#ff735c;text-shadow:-2px -2px 0 #fff,2px -2px 0 #fff,-2px 2px 0 #fff,2px 2px 0 #fff}.modal .tip{font-size:.16rem;color:#9b724e}.modal .over-button-b{width:70%;margin:.1rem auto 0}.modal .back-button{width:70%;margin:.1rem auto 0;padding:.2rem 0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:3px solid #fff;border-radius:.3rem;color:#fff;font-size:.3rem;font-weight:bold;cursor:pointer;text-align:center;display:block}.landing .session-message{position:absolute;bottom:1.5rem;width:100%;color:#fff;font-size:.2rem;text-align:center;display:none}.wxShare{background:#000;position:absolute;top:0;left:0;width:100%;height:100%;z-index:11;opacity:.9}.wxShare img{width:50%;float:right;margin:10px 10px 0 0}@font-face{font-family:wenxue;src:url(assets/wenxue.eot);src:url(assets/wenxue.eot),url(assets/wenxue.woff),url(assets/wenxue.ttf),url(assets/wenxue.svg)}.font-wenxue{font-family:wenxue}</style></head><body><canvas id="canvas" class="hide"></canvas><div class="content"><div class="loading"><div class="main"><img src="./assets/main-loading.gif"><div class="progress"><div class="title font-wenxue">0%</div><div class="bar"><div class="sub"><div class="percent"></div></div></div><div class="text">Loading...</div></div></div></div><div class="landing hide"><div class="action-1"><img src="./assets/main-index-title.png" class="title swing"></div><div class="action-2"><img id="start" src="./assets/main-index-start.png" class="start"></div><div id="session-message" class="session-message">Setting up your session...</div></div><div id="modal" class="modal hide"><div class="mask"></div><div class="js-modal-content modal-content"><div class="main"><div class="container"><img src="./assets/main-modal-bg.png" class="bg"><div class="modal-main"><div id="over-modal" class="hide js-modal-card"><img src="./assets/main-modal-over.png" class="over-img"><div id="score" class="over-score font-wenxue"></div><div id="over-zero" class="hide"><div class="tip"><p>Try Again!</p><button class="back-button js-reload">BACK</button></div></div></div></div></div></div></div></div><div class="wxShare hide"><img src="./assets/main-share-icon.png"></div></div><script src="./dist/main.js"></script><script src="./assets/zepto-1.1.6.min.js"></script><script>
  // ============================================
  // Flutter Integration Variables
  // ============================================
  var poolId = null;
  var sessionId = null;
  var authToken = null;
  var gameStartTime = null;
  var gameTimerDuration = 15; // Default timer duration in seconds
  var apiServerUrl = 'https://api.metaninza.net'; // Default API server URL
  var sessionReady = false; // Track if session parameters are ready
  var scoreSubmitting = false; // Track if score is being submitted
  var scoreSubmissionComplete = false; // Track if score submission is complete
  var gameTimer = null; // Current timer value
  var gameTimerStartTime = undefined; // When the timer started (timestamp)
  var gameTimerPausedElapsed = undefined; // Elapsed time when paused

  // Get URL parameters for Flutter integration (fallback method)
  function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
  }

  // Initialize Flutter parameters - priority: window.__GAME_SESSION__ > URL params > postMessage
  function initFlutterParams() {
    // Request Flutter for parameters if not available
    if (!window.__GAME_SESSION__ && !sessionId && !authToken) {
      console.log('Requesting Flutter for session parameters...');
      // Try to request via postMessage
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'requestSessionParams' }, '*');
      } else if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler('requestSessionParams');
      }
    }
    
    // First, try to get from window.__GAME_SESSION__ (Flutter InAppWebView injection)
    if (window.__GAME_SESSION__) {
      sessionId = window.__GAME_SESSION__.sessionId;
      authToken = window.__GAME_SESSION__.token;
      
      // Check if session has expired
      if (window.__GAME_SESSION__.expiresAt && Date.now() > window.__GAME_SESSION__.expiresAt) {
        console.warn('Game session has expired');
        sessionId = null;
        authToken = null;
      }
      
      // poolId might be in the session object or URL
      if (window.__GAME_SESSION__.poolId) {
        poolId = window.__GAME_SESSION__.poolId;
      } else {
        poolId = getUrlParameter('poolId');
      }
      
      // Get timer duration from Flutter (in seconds)
      if (window.__GAME_SESSION__.timerDuration !== undefined) {
        gameTimerDuration = parseInt(window.__GAME_SESSION__.timerDuration) || 15;
      } else if (window.__GAME_SESSION__.timer !== undefined) {
        gameTimerDuration = parseInt(window.__GAME_SESSION__.timer) || 15;
      }
      
      // Get API server URL from Flutter
      if (window.__GAME_SESSION__.apiServerUrl) {
        apiServerUrl = window.__GAME_SESSION__.apiServerUrl;
      } else if (window.__GAME_SESSION__.apiServer) {
        apiServerUrl = window.__GAME_SESSION__.apiServer;
      }
    } else {
      // Fallback to URL parameters
      poolId = getUrlParameter('poolId');
      sessionId = getUrlParameter('sessionId');
      authToken = getUrlParameter('authToken');
      
      // Get timer from URL parameter if available
      var urlTimer = getUrlParameter('timer');
      if (urlTimer) {
        gameTimerDuration = parseInt(urlTimer) || 15;
      }
      
      // Get API server URL from URL parameter if available
      var urlApiServer = getUrlParameter('apiServerUrl') || getUrlParameter('apiServer');
      if (urlApiServer) {
        apiServerUrl = urlApiServer;
      }
    }
    
    // Also listen for postMessage if embedded (additional fallback)
    if (window.parent && window.parent !== window) {
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'flutterParams') {
          poolId = event.data.poolId || poolId;
          sessionId = event.data.sessionId || sessionId;
          authToken = event.data.authToken || authToken;
          if (event.data.timerDuration) {
            gameTimerDuration = parseInt(event.data.timerDuration) || 15;
          }
          if (event.data.apiServerUrl || event.data.apiServer) {
            apiServerUrl = event.data.apiServerUrl || event.data.apiServer;
          }
          // Update session ready flag
          if (sessionId && authToken) {
            sessionReady = true;
            showPlayButton();
          }
        }
      });
    }
    
    // Debug mode: Allow setting session via URL parameter for testing
    var debugMode = getUrlParameter('debug') === 'true';
    if (debugMode && !sessionId && !authToken) {
      // For testing: allow setting via URL parameters when debug=true
      poolId = getUrlParameter('poolId') || poolId || 'test-pool-123';
      sessionId = getUrlParameter('sessionId') || sessionId || 'test-session-456';
      authToken = getUrlParameter('authToken') || authToken || 'test-token-789';
      console.log('DEBUG MODE: Using test parameters');
    }
    
    // Update session ready flag
    if (sessionId && authToken) {
      sessionReady = true;
      console.log('Flutter session initialized successfully', {
        poolId: poolId,
        sessionId: sessionId,
        timerDuration: gameTimerDuration,
        apiServerUrl: apiServerUrl
      });
    } else {
      sessionReady = false;
      console.log('Flutter session parameters not found - waiting for session...');
    }
  }

  // Function to check session and update UI
  function checkSessionAndUpdateUI() {
    var wasReady = sessionReady;
    initFlutterParams();
    
    // If session just became ready, show the play button
    if (sessionReady && !wasReady) {
      showPlayButton();
    }
    
    // If session is not ready, keep checking periodically
    if (!sessionReady) {
      setTimeout(checkSessionAndUpdateUI, 500);
    }
  }

  // Control play button visibility
  function showPlayButton() {
    if (sessionReady) {
      $('#start').show();
      $('#session-message').hide();
    } else {
      $('#start').hide();
      $('#session-message').show();
    }
  }

  function hidePlayButton() {
    $('#start').hide();
    $('#session-message').show();
  }

  // Send message to Flutter app (for API responses, errors, etc.)
  function sendMessageToFlutter(type, data) {
    var message = {
      type: type,
      data: data
    };
    
    if (window.parent && window.parent !== window) {
      // If in iframe, send message to parent
      window.parent.postMessage(message, '*');
    } else if (window.flutter_inappwebview) {
      // If using Flutter InAppWebView
      window.flutter_inappwebview.callHandler('onMessage', message);
    } else {
      console.log('Flutter message:', message);
    }
  }

  // Submit score to Flutter backend
  function submitScoreToFlutter() {
    // Check if required parameters are available
    if (!poolId || !sessionId || !authToken) {
      console.log('Flutter parameters not available. Score not submitted.');
      showBackButton();
      updateGameOverMessage('GAME OVER');
      return;
    }
    
    // Mark that we're submitting
    scoreSubmitting = true;
    scoreSubmissionComplete = false;
    
    // Calculate time taken in seconds
    var timeTaken = gameTimerDuration; // Default to full timer duration
    
    if (game && game.getVariable) {
      var currentTimer = game.getVariable('GAME_TIMER');
      if (currentTimer !== undefined && currentTimer > 0) {
        // Game ended early, calculate time taken
        timeTaken = gameTimerDuration - currentTimer;
        timeTaken = Math.ceil(timeTaken);
      } else if (currentTimer !== undefined && currentTimer <= 0) {
        // Timer reached 0, full timer duration
        timeTaken = gameTimerDuration;
      }
    }
    
    // Ensure time is at least 1 second and at most timer duration
    timeTaken = Math.max(1, Math.min(gameTimerDuration, timeTaken));
    
    // Use injected API server URL or default
    var baseUrl = apiServerUrl || 'https://api.metaninza.net';
    baseUrl = baseUrl.replace(/\/$/, ''); // Remove trailing slash
    var url = baseUrl + '/api/v1/game-pools/' + poolId + '/sessions/' + sessionId + '/submit-score';
    var data = {
      score: score || 0,
      time: timeTaken
    };
    
    // Make API request
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + authToken
      },
      body: JSON.stringify(data)
    })
    .then(async function(response) {
      var responseData;
      try {
        responseData = await response.json();
      } catch (e) {
        responseData = {
          error: 'Failed to parse response',
          message: response.statusText || 'Unknown error',
          status: response.status
        };
      }
      
      if (!response.ok) {
        // Error - send to Flutter
        console.error('Error submitting score:', responseData);
        sendMessageToFlutter('scoreSubmitError', {
          status: response.status,
          error: responseData
        });
        // Mark submission complete and show back button
        scoreSubmitting = false;
        scoreSubmissionComplete = true;
        updateGameOverMessage('GAME OVER');
        showBackButton();
        return;
      }
      
      // Success - send to Flutter
      console.log('Score submitted successfully:', responseData);
      sendMessageToFlutter('scoreSubmitSuccess', {
        status: response.status,
        data: responseData
      });
      
      // Mark submission complete and show back button
      scoreSubmitting = false;
      scoreSubmissionComplete = true;
      updateGameOverMessage('GAME OVER');
      showBackButton();
    })
    .catch(function(error) {
      // Network error
      console.error('Error submitting score:', error);
      var errorData = {
        error: 'Network error',
        message: error.message || 'Failed to submit score',
        status: 0
      };
      sendMessageToFlutter('scoreSubmitError', {
        status: 0,
        error: errorData
      });
      
      // Mark submission complete and show back button
      scoreSubmitting = false;
      scoreSubmissionComplete = true;
      updateGameOverMessage('GAME OVER');
      showBackButton();
    });
  }

  // Update game over message
  function updateGameOverMessage(text) {
    var tipElement = $('.tip p');
    if (tipElement.length) {
      tipElement.text(text);
    }
  }

  // Show/hide back button
  function showBackButton() {
    $('.js-reload').show();
  }

  function hideBackButton() {
    $('.js-reload').hide();
  }

  // Send message to Flutter app to close window
  function closeFlutterWindow() {
    if (window.parent && window.parent !== window) {
      // If in iframe, send message to parent
      window.parent.postMessage({ type: 'closeGame' }, '*');
    } else if (window.flutter_inappwebview) {
      // If using Flutter InAppWebView
      window.flutter_inappwebview.callHandler('closeGame');
    } else {
      // Fallback: try to close window
      window.close();
    }
  }

var domReady, loadFinish, canvasReady, loadError, gameStart, game, score, successCount
  // init window height and width
  var gameWidth = window.innerWidth
  var gameHeight = window.innerHeight
  var ratio = 1.5
  if (gameHeight / gameWidth < ratio) {
    gameWidth = Math.ceil(gameHeight / ratio)
  }
  $('.content').css({ "height": gameHeight + "px", "width": gameWidth + "px" })
  $('.js-modal-content').css({ "width": gameWidth + "px" })

  // loading animation
  function hideLoading() {
    if (domReady && canvasReady) {
      $('#canvas').show()
      loadFinish = true
      setTimeout(function () {
        $('.loading').hide()
        $('.landing').show()
        // Check session and update UI
        checkSessionAndUpdateUI();
        // Show or hide play button based on session
        if (sessionReady) {
          showPlayButton();
        } else {
          hidePlayButton();
        }
      }, 1000)
    }
  }

  function updateLoading(status) {
    var success = status.success
    var total = status.total
    var failed = status.failed
    if (failed > 0 && !loadError) {
      loadError = true
      alert('Network error... Please try again.')
      return
    }
    var percent = parseInt((success / total) * 100);
    if (percent === 100 && !canvasReady) {
      canvasReady = true
      hideLoading()
    }
    percent = percent > 98 ? 98 : percent
    percent = percent + '%'
    $('.loading .title').text(percent);
    $('.loading .percent').css({
      'width': percent
    })
  }

  function overShowOver() {
    $('#modal').show()
    $('#over-modal').show()
    $('#over-zero').show()
    
    // Reset score submission state
    scoreSubmitting = false;
    scoreSubmissionComplete = false;
    
    // Hide back button initially
    hideBackButton();
    
    // Update game over message
    if (poolId && sessionId && authToken) {
      updateGameOverMessage('Submitting score...');
    } else {
      updateGameOverMessage('GAME OVER');
      // If no session, show back button immediately
      showBackButton();
    }
    
    // Submit score to Flutter backend
    submitScoreToFlutter();
  }

  // game customization options
  const option = {
    width: gameWidth,
    height: gameHeight,
    canvasId: 'canvas',
    soundOn: true,
    timerDuration: gameTimerDuration, // Pass timer duration to game
    setGameScore: function (s) {
      score = s
    },
    setGameSuccess: function (s) {
      successCount = s
    },
    setGameFailed: function (f) {
      $('#score').text(score)
      if (f >= 3) overShowOver()
    }
  }

  // game init with option
  function gameReady() {
    // Initialize Flutter params before game loads
    initFlutterParams();
    
    game = TowerGame(option)
    game.load(function () {
      game.init()
      
      // Set timer duration from Flutter
      if (game && game.setVariable) {
        game.setVariable('GAME_TIMER', gameTimerDuration);
      }
      
      setTimeout(function () {
        game.playBgm()
      })
    }, updateLoading)
    
    // Check for session after a short delay
    setTimeout(function() {
      checkSessionAndUpdateUI();
    }, 100);
  }

  var isWechat = navigator.userAgent.toLowerCase().indexOf("micromessenger") !== -1
  if (isWechat) {
    document.addEventListener("WeixinJSBridgeReady", gameReady, false)
  } else {
    gameReady()
  }

  function indexHide() {
    $('.landing .action-1').addClass('slideTop')
    $('.landing .action-2').addClass('slideBottom')
    setTimeout(function () {
      $('.landing').hide()
    }, 950)
  }

  // click event
  $('#start').on('click', function () {
    if (gameStart) return
    if (!sessionReady) {
      return false; // Don't start game if session not ready
    }
    gameStart = true
    gameStartTime = Date.now();
    setTimeout(function () {
      game.playBgm()
    })
    indexHide()
    setTimeout(function() {
      game.start();
      // Initialize timer when game starts
      if (game && game.setVariable) {
        game.setVariable('GAME_TIMER_START_TIME', Date.now());
        game.setVariable('GAME_TIMER', gameTimerDuration);
      }
    }, 400)
  })

  $('.js-reload').on('click', function () {
    closeFlutterWindow();
    return false;
  })


  // listener
  window.addEventListener('load', function () {
    domReady = true
    hideLoading()
    
    // Initialize Flutter params on load
    initFlutterParams();
    
    // Check for session after a short delay
    setTimeout(function() {
      checkSessionAndUpdateUI();
    }, 100);
    
    // Start periodic checking if session not ready
    if (!sessionReady) {
      setTimeout(checkSessionAndUpdateUI, 500);
    }
    
    // Re-check on visibility change
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        checkSessionAndUpdateUI();
      }
    });
    
    // Also listen for focus events
    window.addEventListener('focus', function() {
      checkSessionAndUpdateUI();
    });
  }, false);</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YCWZ8ZDCH2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-YCWZ8ZDCH2")</script></body></html>